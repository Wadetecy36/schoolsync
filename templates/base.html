<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CRITICAL FIX: Add CSRF Token Meta Tag -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>{% block title %}SchoolSync Pro{% endblock %}</title>
    
    <!-- FAVICON LINK -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        /* Material Icons Setup */
        .material-icons-round {
            font-family: 'Material Icons Round';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            vertical-align: middle;
        }
        
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-primary { background: linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%); }
        .gradient-success { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        .gradient-warning { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        .gradient-danger { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="glass p-2 rounded-xl">
                        <i class="material-icons-round text-white text-xl">school</i>
                    </div>
                    <div>
                        <span class="text-white text-lg font-bold">SchoolSync Pro</span>
                    </div>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-1">
                    <a href="/" class="nav-link px-4 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition flex items-center">
                        <i class="material-icons-round text-xl mr-2">dashboard</i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/students" class="nav-link px-4 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition flex items-center">
                        <i class="material-icons-round text-xl mr-2">people</i>
                        <span>Students</span>
                    </a>
                    <a href="/import" class="nav-link px-4 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition flex items-center">
                        <i class="material-icons-round text-xl mr-2">cloud_upload</i>
                        <span>Import</span>
                    </a>
                </div>
                
                <!-- User Profile (Desktop) -->
                {% if current_user.is_authenticated %}
                <div class="hidden md:flex items-center space-x-4">
                    <span class="text-white text-sm font-medium">{{ current_user.full_name }}</span>
                    
                    <!-- Settings Button -->
                    <a href="/settings" class="text-white hover:text-blue-200 transition" title="Settings">
                        <i class="material-icons-round">settings</i>
                    </a>

                    <!-- Logout Button -->
                    <a href="/logout" class="text-white hover:text-red-200 transition" title="Logout">
                        <i class="material-icons-round">logout</i>
                    </a>
                </div>
                {% endif %}

                <!-- Mobile Menu Button (Hamburger) -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="text-white p-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition focus:outline-none">
                        <i class="material-icons-round text-2xl">menu</i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="md:hidden border-t border-white border-opacity-20 hidden bg-gradient-to-b from-indigo-600 to-purple-700">
            <div class="px-4 py-3 space-y-1">
                <a href="/" class="block px-3 py-2 rounded-md text-white hover:bg-white hover:bg-opacity-10 transition">
                    <div class="flex items-center">
                        <i class="material-icons-round md-20 mr-3">dashboard</i>
                        <span>Dashboard</span>
                    </div>
                </a>
                <a href="/students" class="block px-3 py-2 rounded-md text-white hover:bg-white hover:bg-opacity-10 transition">
                    <div class="flex items-center">
                        <i class="material-icons-round md-20 mr-3">people</i>
                        <span>Students</span>
                    </div>
                </a>
                <a href="/import" class="block px-3 py-2 rounded-md text-white hover:bg-white hover:bg-opacity-10 transition">
                    <div class="flex items-center">
                        <i class="material-icons-round md-20 mr-3">cloud_upload</i>
                        <span>Import</span>
                    </div>
                </a>
                
                <!-- Settings Link for Mobile -->
                <a href="/settings" class="block px-3 py-2 rounded-md text-white hover:bg-white hover:bg-opacity-10 transition">
                    <div class="flex items-center">
                        <i class="material-icons-round md-20 mr-3">settings</i>
                        <span>Settings</span>
                    </div>
                </a>

                {% if current_user.is_authenticated %}
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <div class="px-3 py-2 text-sm text-indigo-100 font-medium">
                        Signed in as {{ current_user.full_name }}
                    </div>
                    <a href="/logout" class="block px-3 py-2 rounded-md text-red-200 hover:bg-red-800 hover:bg-opacity-30 transition">
                        <div class="flex items-center">
                            <i class="material-icons-round md-20 mr-3">logout</i>
                            <span>Logout</span>
                        </div>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="animate-fade-in">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-2xl p-8 shadow-2xl">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full spinner mb-4"></div>
                <p class="text-lg font-semibold">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Global Scripts -->
    <script>
        // Mobile menu toggle logic
        const mobileMenuBtn = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Toast notification system
        window.showToast = function(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icons = { success: 'check_circle', error: 'error', warning: 'warning', info: 'info' };
            
            toast.className = `${colors[type]} text-white p-4 rounded-lg shadow-lg flex items-center justify-between animate-slide-up`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="material-icons-round mr-3 text-xl">${icons[type]}</i>
                    <span>${message}</span>
                </div>
                <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.remove()">
                    <i class="material-icons-round">close</i>
                </button>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        };

        // Loading overlay
        window.loading = {
            show: function(message = 'Loading...') {
                const overlay = document.getElementById('loading-overlay');
                overlay.querySelector('p').textContent = message;
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            },
            hide: function() {
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        };

        // CRITICAL FIX: Enhanced API helper with CSRF Support
        window.apiRequest = async function(url, options = {}) {
            loading.show(options.loadingMessage || 'Processing...');
            
            // Get CSRF Token from meta tag
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
            
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Send token in header
            };

            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `Request failed with status ${response.status}`);
                }
                
                loading.hide();
                return data;
                
            } catch (error) {
                loading.hide();
                showToast(error.message || 'An error occurred', 'error');
                console.error('API Error:', error);
                throw error;
            }
        };

        window.debounce = function(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>