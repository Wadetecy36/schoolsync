{% extends "base.html" %}

{% block title %}Students - SchoolSync Pro{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-theme-main">Students</h1>
            <p class="text-theme-muted">Browse and manage student records</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <!-- Delete All Button -->
            <button onclick="openDeleteAllModal()" class="px-4 py-2 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 transition flex items-center group">
                <i class="material-icons-round mr-2">delete_sweep</i>
                <span>Delete All</span>
            </button>

            <a href="/import" class="px-6 py-2 rounded-xl border border-white/10 hover:bg-white/10 text-theme-main transition flex items-center group">
                <i class="material-icons-round mr-2 text-gold group-hover:scale-110 transition">cloud_upload</i>
                <span>Import</span>
            </a>
            <button onclick="openAddModal()" class="btn-gold px-6 py-2 rounded-xl text-black flex items-center font-bold shadow-lg hover:shadow-yellow-500/20 transition">
                <i class="material-icons-round mr-2">person_add</i>
                <span>Add Student</span>
            </button>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-500/20"></div>
            <p class="text-theme-muted text-sm">Total Students</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="total-count">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-blue-500/20">groups</i>
        </div>
        
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-green-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-green-500/20"></div>
            <p class="text-theme-muted text-sm">Avg Age</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="avg-age">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-green-500/20">cake</i>
        </div>
        
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-purple-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-purple-500/20"></div>
            <p class="text-theme-muted text-sm">Top Program</p>
            <p class="text-xl font-bold text-theme-main mt-1 truncate" id="top-program">-</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-purple-500/20">school</i>
        </div>
        
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-yellow-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-yellow-500/20"></div>
            <p class="text-theme-muted text-sm">New This Month</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="new-this-month">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-yellow-500/20">person_add</i>
        </div>
    </div>

    <!-- Quick Add Form -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleQuickAdd()">
            <h3 class="font-bold text-theme-main flex items-center">
                <i class="material-icons-round text-gold mr-2">flash_on</i>
                Quick Add Student
            </h3>
            <i id="quick-add-arrow" class="material-icons-round text-theme-muted">keyboard_arrow_down</i>
        </div>
        
        <div id="quick-add-form" class="hidden mt-6 pt-6 border-t border-white/10">
            <form id="form-quick-add" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" name="name" placeholder="Full Name *" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    
                    <select name="program" id="quick-program" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500" onchange="updateClassOptions('quick')">
                        <option value="">Select Program...</option>
                    </select>

                    <select name="class_room" id="quick-class" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Class...</option>
                    </select>

                    <button type="submit" class="btn-gold px-6 py-3 rounded-xl text-black flex items-center justify-center font-bold">
                        <i class="material-icons-round mr-2">add</i> Add
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Actions & Bulk -->
    <div class="glass-card p-4 flex flex-col md:flex-row gap-4 items-center justify-between">
        <div class="flex bg-black/20 rounded-lg p-1">
            <button onclick="setViewMode('grid')" id="view-grid" class="px-4 py-2 rounded-md text-gold bg-white/10 flex items-center">
                <i class="material-icons-round mr-2">grid_view</i> Grid
            </button>
            <button onclick="setViewMode('table')" id="view-table" class="px-4 py-2 rounded-md text-theme-muted flex items-center">
                <i class="material-icons-round mr-2">table_rows</i> Table
            </button>
        </div>
        
        <!-- Bulk Action Logic (Appears when items selected) -->
        <div id="bulk-actions-panel" class="hidden flex gap-4 items-center bg-gold-500/10 px-4 py-2 rounded-xl border border-gold-500/20">
            <div class="flex items-center bg-gold-500/20 px-3 py-1 rounded-lg text-gold border border-gold-500/30">
                <i class="material-icons-round text-sm mr-2">check_box</i>
                <span id="selected-count" class="font-bold">0</span> &nbsp;Selected
            </div>
            
            <div class="flex items-center gap-2">
                <select id="bulk-action" class="px-4 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm focus:border-gold-500">
                    <option value="">Select Action...</option>
                    <option value="move-form">Change Form Level</option>
                    <option value="move-hall">Move Hall</option>
                    <option value="update-program">Update Program</option>
                    <option value="email">Send Email</option>
                    <option value="delete">Delete</option>
                </select>
                <button onclick="executeBulkAction()" class="btn-gold px-4 py-2 rounded-lg text-sm text-black font-bold">Apply</button>
            </div>
            <button onclick="clearSelections()" class="text-theme-muted hover:text-white text-sm flex items-center"><i class="material-icons-round text-sm mr-1">close</i> Clear</button>
        </div>
        
        <!-- Export -->
        <div class="flex gap-2">
            <button onclick="exportToCSV()" class="p-2 text-green-400 hover:bg-white/10 rounded-lg transition" title="Export CSV">
                <i class="material-icons-round">description</i>
            </button>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar Filters -->
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-card p-6 sticky top-24">
                <h3 class="font-bold text-theme-main mb-4 flex items-center"><i class="material-icons-round text-gold mr-2">filter_list</i> Filters</h3>
                <div class="mb-6 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                    <p class="text-sm text-blue-300 font-medium text-center">Showing <span id="filtered-count" class="text-white font-bold">0</span> students</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Search</label>
                        <input type="text" id="name-search" placeholder="Name, ID..." class="w-full pl-3 pr-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm focus:border-gold-500 transition">
                    </div>
                    <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Hall</label>
                        <select id="filter-hall" class="w-full px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm transition" onchange="applyFilters()">
                            <option value="">All Halls</option>
                        </select>
                    </div>
                     <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Program</label>
                        <select id="filter-program" class="w-full px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm transition" onchange="applyFilters()">
                            <option value="">All Programs</option>
                        </select>
                    </div>
                    <button onclick="resetAllFilters()" class="w-full py-2 border border-white/10 rounded-lg text-theme-muted hover:text-white hover:bg-white/5 transition text-sm flex items-center justify-center">
                        <i class="material-icons-round text-sm mr-2">refresh</i> Reset Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Area -->
        <div class="lg:col-span-3">
            <!-- Results Grid -->
            <div id="students-grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="students-table-view" class="hidden glass-card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-black/20 text-theme-muted text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox" id="select-all-table" class="rounded bg-black/20 border-white/20 text-gold focus:ring-0"></th>
                                <th class="px-6 py-3">Student</th>
                                <th class="px-6 py-3">Program</th>
                                <th class="px-6 py-3">Class</th>
                                <th class="px-6 py-3">Hall</th>
                                <th class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="text-sm text-theme-main divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div id="loading-state" class="text-center py-20 hidden">
                <div class="w-12 h-12 border-4 border-gold-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-theme-muted">Loading students...</p>
            </div>
            <div id="empty-state" class="hidden text-center py-20">
                <i class="material-icons-round text-4xl text-theme-muted mb-3">search_off</i>
                <h3 class="text-xl font-bold text-theme-main">No students found</h3>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="hidden flex items-center justify-between pt-6 mt-6 border-t border-white/10">
                <span class="text-sm text-theme-muted">
                    Showing <span id="pagination-start" class="text-white font-bold">0</span> to <span id="pagination-end" class="text-white font-bold">0</span> of <span id="pagination-total" class="text-white font-bold">0</span>
                </span>
                <div class="flex space-x-2">
                    <button id="prev-page" class="p-2 rounded-lg border border-white/10 hover:bg-white/10 text-theme-muted disabled:opacity-30"><i class="material-icons-round">chevron_left</i></button>
                    <button id="next-page" class="p-2 rounded-lg border border-white/10 hover:bg-white/10 text-theme-muted disabled:opacity-30"><i class="material-icons-round">chevron_right</i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- ADD/EDIT STUDENT (With Photo Upload) -->
<div id="add-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 animate-fade-in border border-white/10">
        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h3 class="text-2xl font-bold text-theme-main" id="modal-title">Student Details</h3>
            <button onclick="closeAddModal()" class="text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        </div>
        
        <form id="form-main-student" class="space-y-6">
            <input type="hidden" id="edit-student-id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Full Name</label>
                    <input type="text" name="name" id="modal-name" required class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Gender</label>
                    <select name="gender" id="modal-gender" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>

                <!-- Program -->
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Program</label>
                    <select name="program" id="modal-program" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500" onchange="updateClassOptions('modal')">
                        <option value="">Select Program...</option>
                    </select>
                </div>

                <!-- Hall -->
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Hall of Residence</label>
                    <select name="hall" id="modal-hall" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Hall...</option>
                    </select>
                </div>

                <!-- Class -->
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Class</label>
                    <select name="class_room" id="modal-class" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Class...</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Date of Birth</label>
                    <input type="date" name="date_of_birth" id="modal-dob" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Email</label>
                    <input type="email" name="email" id="modal-email" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Phone</label>
                    <input type="tel" name="phone" id="modal-phone" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
            </div>

            <!-- Photo Upload Field -->
            <div class="mt-4 p-4 border border-dashed border-white/20 rounded-xl text-center hover:bg-white/5 transition cursor-pointer">
                <label class="cursor-pointer block">
                    <i class="material-icons-round text-gold text-2xl block mb-2">add_a_photo</i>
                    <span class="text-sm text-theme-muted">Upload Profile Picture</span>
                    <input type="file" name="photo" accept="image/*" class="hidden">
                </label>
            </div>

            <div class="border-t border-white/10 pt-4">
                <p class="text-gold text-sm font-bold mb-3 uppercase tracking-wider">Guardian Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="guardian_name" id="modal-gname" placeholder="Guardian Name" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    <input type="tel" name="guardian_phone" id="modal-gphone" placeholder="Guardian Phone" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
            </div>
            
            <div class="flex gap-4 pt-2">
                <button type="submit" class="flex-1 btn-gold py-3 rounded-xl text-black font-bold shadow-lg hover:scale-[1.02] transition">Save Student</button>
                <button type="button" onclick="closeAddModal()" class="flex-1 py-3 border border-white/10 rounded-xl text-theme-muted hover:text-white hover:bg-white/10 transition">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- CHANGE FORM LEVEL MODAL -->
<div id="move-form-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-blue-500/30">
        <i class="material-icons-round text-4xl text-blue-400 mb-4">school</i>
        <h3 class="text-xl font-bold text-theme-main mb-2">Change Form Level</h3>
        <p class="text-sm text-theme-muted mb-4">Promote or move selected students to:</p>
        <select id="target-form-select" class="w-full p-3 bg-black/30 border border-white/10 rounded-xl text-theme-main mb-6 focus:border-blue-500">
            <option value="Form 1">Form 1 (Freshman)</option>
            <option value="Form 2">Form 2</option>
            <option value="Form 3">Form 3</option>
            <option value="Completed">Graduated</option>
        </select>
        <div class="flex gap-3">
            <button onclick="confirmMoveForm()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold">Update</button>
            <button onclick="toggleModal('move-form-modal', false)" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
        </div>
    </div>
</div>

<!-- Move Hall Modal -->
<div id="move-hall-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4">Move Students</h3>
        <div class="space-y-4">
            <select id="bulk-new-hall" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                <option value="">Select New Hall...</option>
            </select>
            <div class="flex gap-3">
                <button onclick="confirmMoveHall()" class="flex-1 btn-gold py-2 rounded-lg text-black font-bold">Move</button>
                <button onclick="closeMoveHallModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Program Modal -->
<div id="update-program-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4">Update Program</h3>
        <div class="space-y-4">
            <select id="bulk-new-program" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                <option value="">Select New Program...</option>
            </select>
            <div class="flex gap-3">
                <button onclick="confirmUpdateProgram()" class="flex-1 btn-gold py-2 rounded-lg text-black font-bold">Update</button>
                <button onclick="closeUpdateProgramModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Email Modal -->
<div id="bulk-email-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-lg p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4 flex items-center"><i class="material-icons-round text-blue-400 mr-2">email</i> Send Email</h3>
        <form id="bulk-email-form" class="space-y-4">
            <input type="text" id="email-subject" placeholder="Subject" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-blue-500">
            <textarea id="email-message" rows="5" placeholder="Message..." class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-blue-500"></textarea>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeBulkEmailModal()" class="px-4 py-2 text-theme-muted hover:text-white transition">Cancel</button>
                <button type="submit" class="btn-gold px-6 py-2 rounded-lg text-black font-bold">Send</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete All Modal -->
<div id="delete-all-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-red-500/50 shadow-[0_0_50px_rgba(239,68,68,0.2)]">
        <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 border border-red-500/30">
            <i class="material-icons-round text-4xl">warning</i>
        </div>
        <h3 class="text-2xl font-bold text-red-500 mb-2">Delete Everything?</h3>
        <p class="text-theme-muted mb-6">This will wipe all students and records database. This action is irreversible.</p>
        <input type="password" id="admin-password" placeholder="Enter Admin Password" class="w-full px-4 py-3 bg-black/40 border border-red-500/30 rounded-xl text-white mb-6 focus:border-red-500 focus:ring-1 focus:ring-red-500">
        <div class="flex gap-3">
            <button onclick="confirmDeleteAll()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg">Wipe Data</button>
            <button onclick="closeDeleteAllModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl">Cancel</button>
        </div>
    </div>
</div>

<!-- Single Delete Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-red-500/30">
        <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 shadow-[0_0_20px_rgba(239,68,68,0.2)]">
            <i class="material-icons-round text-3xl">delete_forever</i>
        </div>
        <h3 class="text-xl font-bold text-theme-main mb-2">Delete Student?</h3>
        <p class="text-theme-muted mb-6">Are you sure you want to delete <span id="delete-student-name" class="text-white font-bold"></span>?</p>
        <div class="flex gap-3">
            <button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-bold shadow-lg">Delete</button>
            <button onclick="closeDeleteModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
        </div>
    </div>
</div>

<!-- Quick View Modal -->
<div id="quick-view-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in relative">
        <button onclick="closeQuickViewModal()" class="absolute top-4 right-4 text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        <div id="quick-view-content"></div>
    </div>
</div>


<!-- ADD/EDIT STUDENT MODAL -->
<div id="add-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-3xl max-h-[90vh] overflow-y-auto p-8 animate-fade-in shadow-2xl border border-white/10">
        
        <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
            <h3 class="text-2xl font-bold text-theme-main" id="modal-title">Student Details</h3>
            <button onclick="closeAddModal()" class="text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        </div>
        
        <form id="form-main-student" class="space-y-6" enctype="multipart/form-data">
            <input type="hidden" id="edit-student-id">
            
            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- PROFILE PICTURE SECTION -->
                <div class="lg:w-1/3 flex flex-col items-center">
                    <div class="relative group cursor-pointer w-48 h-48">
                        
                        <!-- 1. The Actual Image (Hidden by default, shown if exists) -->
                        <img id="photo-display" src="" class="w-full h-full rounded-full object-cover border-4 border-white/10 shadow-2xl bg-black/50 hidden">
                        
                        <!-- 2. The Placeholder (Shown if no image) -->
                        <div id="photo-placeholder" class="w-full h-full rounded-full flex items-center justify-center bg-gradient-to-br from-gray-700 to-black border-4 border-white/10 shadow-2xl">
                             <i class="material-icons-round text-6xl text-white/50">person</i>
                        </div>
                        
                        <!-- Edit Overlay -->
                        <div class="absolute inset-0 rounded-full bg-black/50 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                            <i class="material-icons-round text-white text-3xl mb-1">cloud_upload</i>
                            <span class="text-xs text-white font-medium">Click to Upload</span>
                        </div>
                        
                        <!-- File Input -->
                        <input type="file" name="photo" id="photo-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" onchange="previewSelectedImage(this)">
                    </div>

                    <!-- Progress Bar -->
                    <div id="upload-progress-container" class="w-full mt-4 bg-gray-700 h-2 rounded-full overflow-hidden hidden">
                        <div id="upload-progress-bar" class="h-full bg-gradient-to-r from-gold-500 to-yellow-300 w-0 transition-all duration-200"></div>
                    </div>
                </div>

                <!-- FORM FIELDS (Right Side) -->
                <div class="lg:w-2/3 grid grid-cols-1 gap-5">
                    <!-- Standard fields (same as before) -->
                    <input type="text" name="name" id="modal-name" placeholder="Full Name" required class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    <div class="grid grid-cols-2 gap-4">
                        <select name="gender" id="modal-gender" class="p-3 bg-black/30 border border-white/10 rounded-xl text-theme-main"><option value="Male">Male</option><option value="Female">Female</option></select>
                        <select name="program" id="modal-program" class="p-3 bg-black/30 border border-white/10 rounded-xl text-theme-main" onchange="updateClassOptions('modal')"></select>
                    </div>
                    <!-- (Add other fields: Class, Hall, Email, etc...) -->
                    <select name="class_room" id="modal-class" class="p-3 bg-black/30 border border-white/10 rounded-xl text-theme-main"></select>
                </div>
            </div>

            <!-- BUTTONS -->
            <div class="flex gap-4 pt-4 border-t border-white/10">
                <button type="submit" id="save-btn" class="flex-1 btn-gold py-3 rounded-xl font-bold text-black shadow-lg hover:scale-[1.01] transition">Save & Upload</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
/* ================================
   SCHOOL CONFIGURATION
================================ */
const CONFIG = {
    halls: [
        "Alema Hall", "Ellen Hall", "Halm Addo Hall", "Nana Wereko Ampem II Hall",
        "Wilson Q .Tei Hall", "Awuletey Hall", "Peter Ala Adjetey Hall",
        "Nana Akuako Sarpong Hall", "Nana Awuah Darko Ampem Hall"
    ],
    programs: [
        "General Science", "Business", "General Arts",
        "Visual Arts", "Agriculture", "Home Economics"
    ],
    classConfig: {
        "General Science": { code: "Science", count: 13 },
        "Business": { code: "Business", count: 9 },
        "General Arts": { code: "GeneralArts", count: 9 },
        "Visual Arts": { code: "VisualArts", count: 3 },
        "Agriculture": { code: "Agriculture", count: 2 },
        "Home Economics": { code: "HomeEcons", count: 2 }
    }
};

/* ================================
   UTILITIES & STATE
================================ */
const debounce = (fn, wait) => {
    let t;
    return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
    };
};

let allStudents = [];
let filteredStudents = [];
let selectedStudents = new Set();
let currentPage = 1;
let itemsPerPage = 12;
let currentViewMode = 'grid';
let deleteStudentId = null;

/* ================================
   IMAGE LIVE PREVIEW (FIX)
================================ */
function previewSelectedImage(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const img = document.getElementById('photo-display');
        const placeholder = document.getElementById('photo-placeholder');

        img.src = e.target.result;
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
    };
    reader.readAsDataURL(file);
}

/* ================================
   DROPDOWNS
================================ */
function populateDropdowns() {
    const fill = (id, options) => {
        const el = document.getElementById(id);
        if (!el) return;
        const first = el.firstElementChild;
        el.innerHTML = '';
        el.appendChild(first);
        options.forEach(v => {
            const o = document.createElement('option');
            o.value = v;
            o.textContent = v;
            el.appendChild(o);
        });
    };

    fill('modal-program', CONFIG.programs);
    fill('modal-hall', CONFIG.halls);
    fill('filter-program', CONFIG.programs);
    fill('filter-hall', CONFIG.halls);
    fill('target-form-select', ['Form 1', 'Form 2', 'Form 3', 'Completed']);
}

function updateClassOptions(ctx) {
    const p = document.getElementById(`${ctx}-program`);
    const c = document.getElementById(`${ctx}-class`);
    if (!p || !c) return;

    const conf = CONFIG.classConfig[p.value];
    c.innerHTML = '<option value="">Select Class...</option>';

    if (!conf) return;

    for (let y = 1; y <= 3; y++) {
        for (let i = 1; i <= conf.count; i++) {
            const name = `${y}-${conf.code}-${i}`;
            c.append(new Option(name, name));
        }
    }
}

/* ================================
   DATA LOADING
================================ */
async function loadStudents() {
    try {
        const data = await apiRequest('/api/students?per_page=2000');
        allStudents = data.students || [];
        filteredStudents = [...allStudents];
        renderStudents();
    } catch {
        showToast('Failed to load students', 'error');
    }
}

/* ================================
   EDIT STUDENT (IMAGE FIX MERGED)
================================ */
function editStudent(id) {
    const s = allStudents.find(x => x.id == id);
    if (!s) return;

    document.getElementById('edit-student-id').value = s.id;
    document.getElementById('modal-name').value = s.name;
    document.getElementById('modal-email').value = s.email || '';
    document.getElementById('modal-phone').value = s.phone || '';
    document.getElementById('modal-gender').value = s.gender || '';
    document.getElementById('modal-dob').value = s.date_of_birth || '';

    // Reset file input
    document.getElementById('photo-input').value = '';

    const img = document.getElementById('photo-display');
    const placeholder = document.getElementById('photo-placeholder');

    if (s.photo_url) {
        img.src = s.photo_url;
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
    } else {
        img.classList.add('hidden');
        placeholder.classList.remove('hidden');
        placeholder.innerHTML = `
            <div class="w-full h-full flex items-center justify-center 
                        bg-blue-900 rounded-full text-white text-5xl font-bold">
                ${s.name.charAt(0)}
            </div>`;
    }

    document.getElementById('modal-hall').value = s.hall || '';
    document.getElementById('modal-program').value = s.program || '';
    updateClassOptions('modal');

    setTimeout(() => {
        document.getElementById('modal-class').value = s.class_room || '';
    }, 50);

    document.getElementById('modal-title').innerText = 'Edit Student';
    toggleModal('add-modal', true);
}

/* ================================
   FORM SUBMISSION (XHR + PROGRESS)
================================ */
document.getElementById('form-main-student').onsubmit = e => {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const editId = document.getElementById('edit-student-id').value;
    const url = editId ? `/api/students/${editId}` : '/api/students';
    const method = editId ? 'PUT' : 'POST';
    const csrf = document.querySelector('meta[name="csrf-token"]').content;

    const bar = document.getElementById('upload-progress-bar');
    const box = document.getElementById('upload-progress-container');
    const btn = document.getElementById('save-btn');

    box.classList.remove('hidden');
    bar.style.width = '0%';
    btn.disabled = true;
    btn.innerText = 'Uploadingâ€¦';

    const xhr = new XMLHttpRequest();
    xhr.open(method, url);
    xhr.setRequestHeader('X-CSRFToken', csrf);

    xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
            bar.style.width = `${(e.loaded / e.total) * 100}%`;
        }
    };

    xhr.onload = () => {
        btn.disabled = false;
        btn.innerText = 'Save & Upload';
        box.classList.add('hidden');

        if (xhr.status >= 200 && xhr.status < 300) {
            showToast('Uploaded Successfully!', 'success');
            toggleModal('add-modal', false);
            loadStudents();
        } else {
            showToast('Upload Failed', 'error');
        }
    };

    xhr.onerror = () => {
        btn.disabled = false;
        showToast('Network Error', 'error');
    };

    xhr.send(formData);
};

/* ================================
   INIT
================================ */
document.addEventListener('DOMContentLoaded', () => {
    populateDropdowns();
    loadStudents();
});
</script>
{% endblock %}
