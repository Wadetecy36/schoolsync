{% extends "base.html" %}

{% block title %}Students - SchoolSync Pro{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-theme-main">Students</h1>
            <p class="text-theme-muted">Browse and manage student records</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <!-- Delete All Button -->
            <button onclick="openDeleteAllModal()" class="px-4 py-2 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 transition flex items-center group">
                <i class="material-icons-round mr-2">delete_sweep</i>
                <span>Delete All</span>
            </button>

            <a href="/import" class="px-6 py-2 rounded-xl border border-white/10 hover:bg-white/10 text-theme-main transition flex items-center group">
                <i class="material-icons-round mr-2 text-gold group-hover:scale-110 transition">cloud_upload</i>
                <span>Import</span>
            </a>
            <button onclick="openAddModal()" class="btn-gold px-6 py-2 rounded-xl text-black flex items-center font-bold shadow-lg hover:shadow-yellow-500/20 transition">
                <i class="material-icons-round mr-2">person_add</i>
                <span>Add Student</span>
            </button>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-500/20"></div>
            <p class="text-theme-muted text-sm">Total Students</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="total-count">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-blue-500/20">groups</i>
        </div>
        
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-green-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-green-500/20"></div>
            <p class="text-theme-muted text-sm">Avg Age</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="avg-age">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-green-500/20">cake</i>
        </div>
        
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-purple-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-purple-500/20"></div>
            <p class="text-theme-muted text-sm">Top Program</p>
            <p class="text-xl font-bold text-theme-main mt-1 truncate" id="top-program">-</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-purple-500/20">school</i>
        </div>
        
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-yellow-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-yellow-500/20"></div>
            <p class="text-theme-muted text-sm">New This Month</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="new-this-month">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-yellow-500/20">person_add</i>
        </div>
    </div>

    <!-- Quick Add Form -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleQuickAdd()">
            <h3 class="font-bold text-theme-main flex items-center">
                <i class="material-icons-round text-gold mr-2">flash_on</i>
                Quick Add Student
            </h3>
            <i id="quick-add-arrow" class="material-icons-round text-theme-muted">keyboard_arrow_down</i>
        </div>
        
        <div id="quick-add-form" class="hidden mt-6 pt-6 border-t border-white/10">
            <form id="form-quick-add" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" name="name" placeholder="Full Name *" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    
                    <select name="program" id="quick-program" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500" onchange="updateClassOptions('quick')">
                        <option value="">Select Program...</option>
                    </select>

                    <select name="class_room" id="quick-class" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Class...</option>
                    </select>

                    <button type="submit" class="btn-gold px-6 py-3 rounded-xl text-black flex items-center justify-center font-bold">
                        <i class="material-icons-round mr-2">add</i> Add
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Actions & Bulk -->
    <div class="glass-card p-4 flex flex-col md:flex-row gap-4 items-center justify-between">
        <div class="flex bg-black/20 rounded-lg p-1">
            <button onclick="setViewMode('grid')" id="view-grid" class="px-4 py-2 rounded-md text-gold bg-white/10 flex items-center">
                <i class="material-icons-round mr-2">grid_view</i> Grid
            </button>
            <button onclick="setViewMode('table')" id="view-table" class="px-4 py-2 rounded-md text-theme-muted flex items-center">
                <i class="material-icons-round mr-2">table_rows</i> Table
            </button>
        </div>
        
        <!-- Bulk Action Logic (Appears when items selected) -->
        <div id="bulk-actions-panel" class="hidden flex gap-4 items-center bg-gold-500/10 px-4 py-2 rounded-xl border border-gold-500/20">
            <div class="flex items-center bg-gold-500/20 px-3 py-1 rounded-lg text-gold border border-gold-500/30">
                <i class="material-icons-round text-sm mr-2">check_box</i>
                <span id="selected-count" class="font-bold">0</span> &nbsp;Selected
            </div>
            
            <div class="flex items-center gap-2">
                <select id="bulk-action" class="px-4 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm focus:border-gold-500">
                    <option value="">Select Action...</option>
                    <option value="move-form">Change Form Level</option>
                    <option value="move-hall">Move Hall</option>
                    <option value="update-program">Update Program</option>
                    <option value="email">Send Email</option>
                    <option value="delete">Delete</option>
                </select>
                <button onclick="executeBulkAction()" class="btn-gold px-4 py-2 rounded-lg text-sm text-black font-bold">Apply</button>
            </div>
            <button onclick="clearSelections()" class="text-theme-muted hover:text-white text-sm flex items-center"><i class="material-icons-round text-sm mr-1">close</i> Clear</button>
        </div>
        
        <!-- Export -->
        <div class="flex gap-2">
            <button onclick="exportToCSV()" class="p-2 text-green-400 hover:bg-white/10 rounded-lg transition" title="Export CSV">
                <i class="material-icons-round">description</i>
            </button>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar Filters -->
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-card p-6 sticky top-24">
                <h3 class="font-bold text-theme-main mb-4 flex items-center"><i class="material-icons-round text-gold mr-2">filter_list</i> Filters</h3>
                <div class="mb-6 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                    <p class="text-sm text-blue-300 font-medium text-center">Showing <span id="filtered-count" class="text-white font-bold">0</span> students</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Search</label>
                        <input type="text" id="name-search" placeholder="Name, ID..." class="w-full pl-3 pr-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm focus:border-gold-500 transition">
                    </div>
                    <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Hall</label>
                        <select id="filter-hall" class="w-full px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm transition" onchange="applyFilters()">
                            <option value="">All Halls</option>
                        </select>
                    </div>
                     <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Program</label>
                        <select id="filter-program" class="w-full px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm transition" onchange="applyFilters()">
                            <option value="">All Programs</option>
                        </select>
                    </div>
                    <button onclick="resetAllFilters()" class="w-full py-2 border border-white/10 rounded-lg text-theme-muted hover:text-white hover:bg-white/5 transition text-sm flex items-center justify-center">
                        <i class="material-icons-round text-sm mr-2">refresh</i> Reset Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Area -->
        <div class="lg:col-span-3">
            <!-- Results Grid -->
            <div id="students-grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="students-table-view" class="hidden glass-card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-black/20 text-theme-muted text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox" id="select-all-table" class="rounded bg-black/20 border-white/20 text-gold focus:ring-0"></th>
                                <th class="px-6 py-3">Student</th>
                                <th class="px-6 py-3">Program</th>
                                <th class="px-6 py-3">Class</th>
                                <th class="px-6 py-3">Hall</th>
                                <th class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="text-sm text-theme-main divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div id="loading-state" class="text-center py-20 hidden">
                <div class="w-12 h-12 border-4 border-gold-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-theme-muted">Loading students...</p>
            </div>
            <div id="empty-state" class="hidden text-center py-20">
                <i class="material-icons-round text-4xl text-theme-muted mb-3">search_off</i>
                <h3 class="text-xl font-bold text-theme-main">No students found</h3>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="hidden flex items-center justify-between pt-6 mt-6 border-t border-white/10">
                <span class="text-sm text-theme-muted">
                    Showing <span id="pagination-start" class="text-white font-bold">0</span> to <span id="pagination-end" class="text-white font-bold">0</span> of <span id="pagination-total" class="text-white font-bold">0</span>
                </span>
                <div class="flex space-x-2">
                    <button id="prev-page" class="p-2 rounded-lg border border-white/10 hover:bg-white/10 text-theme-muted disabled:opacity-30"><i class="material-icons-round">chevron_left</i></button>
                    <button id="next-page" class="p-2 rounded-lg border border-white/10 hover:bg-white/10 text-theme-muted disabled:opacity-30"><i class="material-icons-round">chevron_right</i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- ADD/EDIT STUDENT (With Photo Upload) -->
<div id="add-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 animate-fade-in border border-white/10">
        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h3 class="text-2xl font-bold text-theme-main" id="modal-title">Student Details</h3>
            <button onclick="closeAddModal()" class="text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        </div>
        
        <form id="form-main-student" class="space-y-6">
            <input type="hidden" id="edit-student-id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Full Name</label>
                    <input type="text" name="name" id="modal-name" required class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Gender</label>
                    <select name="gender" id="modal-gender" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>

                <!-- Program -->
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Program</label>
                    <select name="program" id="modal-program" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500" onchange="updateClassOptions('modal')">
                        <option value="">Select Program...</option>
                    </select>
                </div>

                <!-- Hall -->
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Hall of Residence</label>
                    <select name="hall" id="modal-hall" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Hall...</option>
                    </select>
                </div>

                <!-- Class -->
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Class</label>
                    <select name="class_room" id="modal-class" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Class...</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Date of Birth</label>
                    <input type="date" name="date_of_birth" id="modal-dob" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Email</label>
                    <input type="email" name="email" id="modal-email" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Phone</label>
                    <input type="tel" name="phone" id="modal-phone" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
            </div>

            <!-- Photo Upload Field -->
            <div class="mt-4 p-4 border border-dashed border-white/20 rounded-xl text-center hover:bg-white/5 transition cursor-pointer">
                <label class="cursor-pointer block">
                    <i class="material-icons-round text-gold text-2xl block mb-2">add_a_photo</i>
                    <span class="text-sm text-theme-muted">Upload Profile Picture</span>
                    <input type="file" name="photo" accept="image/*" class="hidden">
                </label>
            </div>

            <div class="border-t border-white/10 pt-4">
                <p class="text-gold text-sm font-bold mb-3 uppercase tracking-wider">Guardian Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="guardian_name" id="modal-gname" placeholder="Guardian Name" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    <input type="tel" name="guardian_phone" id="modal-gphone" placeholder="Guardian Phone" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
            </div>
            
            <div class="flex gap-4 pt-2">
                <button type="submit" class="flex-1 btn-gold py-3 rounded-xl text-black font-bold shadow-lg hover:scale-[1.02] transition">Save Student</button>
                <button type="button" onclick="closeAddModal()" class="flex-1 py-3 border border-white/10 rounded-xl text-theme-muted hover:text-white hover:bg-white/10 transition">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- CHANGE FORM LEVEL MODAL -->
<div id="move-form-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-blue-500/30">
        <i class="material-icons-round text-4xl text-blue-400 mb-4">school</i>
        <h3 class="text-xl font-bold text-theme-main mb-2">Change Form Level</h3>
        <p class="text-sm text-theme-muted mb-4">Promote or move selected students to:</p>
        <select id="target-form-select" class="w-full p-3 bg-black/30 border border-white/10 rounded-xl text-theme-main mb-6 focus:border-blue-500">
            <option value="Form 1">Form 1 (Freshman)</option>
            <option value="Form 2">Form 2</option>
            <option value="Form 3">Form 3</option>
            <option value="Completed">Graduated</option>
        </select>
        <div class="flex gap-3">
            <button onclick="confirmMoveForm()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold">Update</button>
            <button onclick="toggleModal('move-form-modal', false)" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
        </div>
    </div>
</div>

<!-- Move Hall Modal -->
<div id="move-hall-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4">Move Students</h3>
        <div class="space-y-4">
            <select id="bulk-new-hall" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                <option value="">Select New Hall...</option>
            </select>
            <div class="flex gap-3">
                <button onclick="confirmMoveHall()" class="flex-1 btn-gold py-2 rounded-lg text-black font-bold">Move</button>
                <button onclick="closeMoveHallModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Program Modal -->
<div id="update-program-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4">Update Program</h3>
        <div class="space-y-4">
            <select id="bulk-new-program" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                <option value="">Select New Program...</option>
            </select>
            <div class="flex gap-3">
                <button onclick="confirmUpdateProgram()" class="flex-1 btn-gold py-2 rounded-lg text-black font-bold">Update</button>
                <button onclick="closeUpdateProgramModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Email Modal -->
<div id="bulk-email-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-lg p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4 flex items-center"><i class="material-icons-round text-blue-400 mr-2">email</i> Send Email</h3>
        <form id="bulk-email-form" class="space-y-4">
            <input type="text" id="email-subject" placeholder="Subject" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-blue-500">
            <textarea id="email-message" rows="5" placeholder="Message..." class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-blue-500"></textarea>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeBulkEmailModal()" class="px-4 py-2 text-theme-muted hover:text-white transition">Cancel</button>
                <button type="submit" class="btn-gold px-6 py-2 rounded-lg text-black font-bold">Send</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete All Modal -->
<div id="delete-all-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-red-500/50 shadow-[0_0_50px_rgba(239,68,68,0.2)]">
        <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 border border-red-500/30">
            <i class="material-icons-round text-4xl">warning</i>
        </div>
        <h3 class="text-2xl font-bold text-red-500 mb-2">Delete Everything?</h3>
        <p class="text-theme-muted mb-6">This will wipe all students and records database. This action is irreversible.</p>
        <input type="password" id="admin-password" placeholder="Enter Admin Password" class="w-full px-4 py-3 bg-black/40 border border-red-500/30 rounded-xl text-white mb-6 focus:border-red-500 focus:ring-1 focus:ring-red-500">
        <div class="flex gap-3">
            <button onclick="confirmDeleteAll()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg">Wipe Data</button>
            <button onclick="closeDeleteAllModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl">Cancel</button>
        </div>
    </div>
</div>

<!-- Single Delete Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-red-500/30">
        <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 shadow-[0_0_20px_rgba(239,68,68,0.2)]">
            <i class="material-icons-round text-3xl">delete_forever</i>
        </div>
        <h3 class="text-xl font-bold text-theme-main mb-2">Delete Student?</h3>
        <p class="text-theme-muted mb-6">Are you sure you want to delete <span id="delete-student-name" class="text-white font-bold"></span>?</p>
        <div class="flex gap-3">
            <button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-bold shadow-lg">Delete</button>
            <button onclick="closeDeleteModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
        </div>
    </div>
</div>

<!-- Quick View Modal -->
<div id="quick-view-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in relative">
        <button onclick="closeQuickViewModal()" class="absolute top-4 right-4 text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        <div id="quick-view-content"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // --- SCHOOL CONFIGURATION FROM CSV ---
    const CONFIG = {
        halls: [
            "Alema Hall", "Ellen Hall", "Halm Addo Hall", "Nana Wereko Ampem II Hall",
            "Wilson Q .Tei Hall", "Awuletey Hall", "Peter Ala Adjetey Hall",
            "Nana Akuako Sarpong Hall", "Nana Awuah Darko Ampem Hall"
        ],
        programs: [
            "General Science", "Business", "General Arts", "Visual Arts", "Agriculture", "Home Economics"
        ],
        // Logic to generate classes: "1-Science-1" to "3-Science-13" based on your CSV structure
        classConfig: {
            "General Science": { code: "Science", count: 13 },
            "Business": { code: "Business", count: 9 },
            "General Arts": { code: "GeneralArts", count: 9 },
            "Visual Arts": { code: "VisualArts", count: 3 },
            "Agriculture": { code: "Agriculture", count: 2 },
            "Home Economics": { code: "HomeEcons", count: 2 }
        }
    };

    // --- UTILS ---
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // --- STATE MANAGEMENT ---
    let allStudents = [];
    let filteredStudents = [];
    let selectedStudents = new Set();
    let currentPage = 1;
    let itemsPerPage = 12;
    let currentViewMode = 'grid';
    let deleteStudentId = null;
    let currentFilters = { search: '', program: '', hall: '', gender: '' };

    document.addEventListener('DOMContentLoaded', () => {
        populateDropdowns();
        loadStudents();
        setupEventListeners();
    });

    // --- DYNAMIC DROPDOWNS ---
    function populateDropdowns() {
        const fill = (id, options) => {
            const el = document.getElementById(id);
            if (!el) return;
            const first = el.firstElementChild; // Save "Select..."
            el.innerHTML = '';
            el.appendChild(first);
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                el.appendChild(option);
            });
        };

        fill('quick-program', CONFIG.programs);
        fill('modal-program', CONFIG.programs);
        fill('filter-program', CONFIG.programs);
        fill('bulk-new-program', CONFIG.programs);
        fill('modal-hall', CONFIG.halls);
        fill('filter-hall', CONFIG.halls);
        fill('bulk-new-hall', CONFIG.halls);
        fill('target-form-select', ['Form 1', 'Form 2', 'Form 3', 'Completed']);
    }

    function updateClassOptions(context) {
        const progSelect = document.getElementById(`${context}-program`);
        const classSelect = document.getElementById(`${context}-class`);
        
        if (!progSelect || !classSelect) return;

        const selectedProg = progSelect.value;
        const conf = CONFIG.classConfig[selectedProg];

        classSelect.innerHTML = '<option value="">Select Class...</option>';
        
        if (conf) {
            for (let year = 1; year <= 3; year++) {
                for (let num = 1; num <= conf.count; num++) {
                    const className = `${year}-${conf.code}-${num}`;
                    const opt = document.createElement('option');
                    opt.value = className;
                    opt.textContent = className;
                    classSelect.appendChild(opt);
                }
            }
        }
    }

    // --- DATA LOADING ---
    async function loadStudents() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        
        try {
            const timestamp = new Date().getTime();
            const data = await apiRequest(`/api/students?per_page=2000&_t=${timestamp}`);
            allStudents = data.students || [];
            filteredStudents = [...allStudents];
            
            updateStats();
            applyFilters();
        } catch (error) {
            console.error('Data Load Error:', error);
            showToast('Failed to load data', 'error');
        } finally {
            document.getElementById('loading-state').classList.add('hidden');
        }
    }

    // --- RENDERING WITH PHOTO SUPPORT ---
    function renderStudents() {
        const grid = document.getElementById('students-grid-view');
        const table = document.getElementById('students-table-view');
        const pagination = document.getElementById('pagination');

        grid.classList.add('hidden'); 
        table.classList.add('hidden');

        if(filteredStudents.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
            pagination.classList.add('hidden');
            return;
        }
        document.getElementById('empty-state').classList.add('hidden');

        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, filteredStudents.length);
        const pageData = filteredStudents.slice(start, end);

        document.getElementById('pagination-start').textContent = start + 1;
        document.getElementById('pagination-end').textContent = end;
        document.getElementById('pagination-total').textContent = filteredStudents.length;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = end >= filteredStudents.length;
        pagination.classList.remove('hidden');

        const safe = (val) => (val === null || val === undefined) ? '' : val;
        const getInitial = (name) => (name ? name.charAt(0) : '?');

        // Calculate age from date_of_birth
        const calculateAge = (dob) => {
            if (!dob) return null;
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        };

        // Grid View with Photo Support
        if (currentViewMode === 'grid') {
            grid.classList.remove('hidden');
            grid.innerHTML = pageData.map(s => {
                const age = calculateAge(s.date_of_birth);
                return `
                <div class="glass-card p-6 group hover:border-gold-500/50 transition relative overflow-hidden">
                    <div class="flex justify-between items-start mb-3">
                        <!-- Profile Pic Logic -->
                        <div class="relative">
                            ${s.photo_url 
                                ? `<img src="${s.photo_url}" class="w-16 h-16 rounded-xl object-cover shadow-lg border border-white/10">` 
                                : `<div class="w-16 h-16 rounded-xl bg-gradient-to-br from-blue-700 to-indigo-900 flex items-center justify-center text-xl font-bold shadow-lg border border-white/10">${getInitial(s.name)}</div>`
                            }
                            <!-- Age Badge -->
                            ${age ? `<span class="absolute -bottom-1 -right-1 bg-black/60 backdrop-blur-md text-[10px] px-1.5 py-0.5 rounded border border-white/10">${age}y</span>` : ''}
                        </div>
                        <input type="checkbox" class="student-checkbox w-5 h-5 rounded bg-black/20 border-white/30 text-gold cursor-pointer focus:ring-0" 
                                onchange="toggleSelection(${s.id}, this.checked)" ${selectedStudents.has(s.id)?'checked':''}>
                    </div>

                    <h3 class="font-bold text-lg text-theme-main truncate" title="${safe(s.name)}">${safe(s.name)}</h3>
                    
                    <!-- BADGES -->
                    <div class="flex flex-wrap gap-2 mt-2 mb-3">
                        <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-0.5 rounded bg-gold-500/10 text-gold border border-gold-500/20">${s.current_form || 'Form 1'}</span>
                        <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-0.5 rounded bg-blue-500/10 text-blue-300 border border-blue-500/20">${s.class_room || 'N/A'}</span>
                    </div>

                    <div class="pt-3 border-t border-white/5 flex justify-between items-center text-theme-muted">
                        <span class="text-xs truncate max-w-[50%]" title="${s.program || 'No Program'}">${s.program || 'No Program'}</span>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="quickView(${s.id})" class="text-blue-400 hover:text-white transition"><i class="material-icons-round text-sm">visibility</i></button>
                            <button onclick="editStudent(${s.id})" class="text-gold hover:text-white transition"><i class="material-icons-round text-sm">edit</i></button>
                            <button onclick="openDeleteModal(${s.id}, '${safe(s.name).replace(/'/g, "\\'")}')" class="text-red-400 hover:text-white transition"><i class="material-icons-round text-sm">delete</i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } 
        // Table View
        else if (currentViewMode === 'table') {
            table.classList.remove('hidden');
            document.getElementById('students-table-body').innerHTML = pageData.map(s => {
                const age = calculateAge(s.date_of_birth);
                return `
                <tr class="hover:bg-white/5 transition group">
                    <td class="px-6 py-4"><input type="checkbox" class="student-checkbox rounded bg-black/20 border-white/20 text-gold focus:ring-0 cursor-pointer" value="${s.id}" ${selectedStudents.has(s.id) ? 'checked' : ''} onchange="toggleSelection(${s.id}, this.checked)"></td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            ${s.photo_url 
                                ? `<img src="${s.photo_url}" class="w-10 h-10 rounded-lg object-cover border border-white/10">` 
                                : `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-900 flex items-center justify-center text-white font-bold border border-white/10">${getInitial(s.name)}</div>`
                            }
                            <div>
                                <div class="font-medium text-theme-main">${safe(s.name)}</div>
                                ${age ? `<div class="text-xs text-theme-muted">${age} years</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-theme-muted">${safe(s.program) || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-blue-500/10 text-blue-300 text-xs border border-blue-500/20">${safe(s.class_room) || '-'}</span></td>
                    <td class="px-6 py-4 text-theme-muted">${safe(s.hall) || '-'}</td>
                    <td class="px-6 py-4 flex gap-2 opacity-50 group-hover:opacity-100 transition">
                        <button onclick="editStudent(${s.id})" class="text-gold hover:scale-110 transition"><i class="material-icons-round text-sm">edit</i></button>
                        <button onclick="openDeleteModal(${s.id}, '${safe(s.name)}')" class="text-red-400 hover:scale-110 transition"><i class="material-icons-round text-sm">delete</i></button>
                    </td>
                </tr>`;
            }).join('');
        }
    }

    // --- INTERACTIONS ---
    function setViewMode(mode) {
        currentViewMode = mode;
        renderStudents();
    }

    function toggleSelection(id, checked) {
        if(checked) selectedStudents.add(id);
        else selectedStudents.delete(id);
        document.getElementById('selected-count').textContent = selectedStudents.size;
        document.getElementById('bulk-actions-panel').classList.toggle('hidden', selectedStudents.size === 0);
    }

    document.getElementById('select-all-table')?.addEventListener('change', (e) => {
        const checked = e.target.checked;
        const visibleIds = filteredStudents.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage).map(s => s.id);
        visibleIds.forEach(id => toggleSelection(id, checked));
        renderStudents();
    });

    function clearSelections() {
        selectedStudents.clear();
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('bulk-actions-panel').classList.add('hidden');
    }

    function toggleQuickAdd() {
        const form = document.getElementById('quick-add-form');
        form.classList.toggle('hidden');
        document.getElementById('quick-add-arrow').textContent = form.classList.contains('hidden') ? 'keyboard_arrow_down' : 'keyboard_arrow_up';
    }

    // --- STATS ---
    function updateStats() {
        if (!allStudents.length) return;
        
        // Total Count
        document.getElementById('total-count').innerText = allStudents.length;
        
        // Average Age
        const ages = allStudents
            .map(s => {
                if (!s.date_of_birth) return null;
                const birthDate = new Date(s.date_of_birth);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) age--;
                return age;
            })
            .filter(age => age !== null);
        
        const avgAge = ages.length ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : 0;
        document.getElementById('avg-age').innerText = avgAge;
        
        // Top Program
        const programCounts = {};
        allStudents.forEach(s => {
            if (s.program) programCounts[s.program] = (programCounts[s.program] || 0) + 1;
        });
        const topProgram = Object.entries(programCounts).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('top-program').innerText = topProgram ? topProgram[0] : '-';
        
        // New This Month
        const now = new Date();
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();
        const newThisMonth = allStudents.filter(s => {
            if (!s.created_at) return false;
            const created = new Date(s.created_at);
            return created.getMonth() === thisMonth && created.getFullYear() === thisYear;
        }).length;
        document.getElementById('new-this-month').innerText = newThisMonth;
    }

    // --- FILTERING ---
    function applyFilters() {
        const term = document.getElementById('name-search').value.toLowerCase();
        const hall = document.getElementById('filter-hall').value;
        const prog = document.getElementById('filter-program').value;
        
        filteredStudents = allStudents.filter(s => {
            if(term && !s.name.toLowerCase().includes(term) && !String(s.id).includes(term)) return false;
            if(hall && s.hall !== hall) return false;
            if(prog && s.program !== prog) return false;
            return true;
        });
        document.getElementById('filtered-count').innerText = filteredStudents.length;
        currentPage = 1;
        renderStudents();
    }

    document.getElementById('name-search').addEventListener('input', debounce(applyFilters, 300));

    function resetAllFilters() {
        filteredStudents = [...allStudents];
        document.getElementById('name-search').value = '';
        document.getElementById('filter-hall').value = '';
        document.getElementById('filter-program').value = '';
        document.getElementById('filtered-count').innerText = allStudents.length;
        currentPage = 1;
        renderStudents();
    }

    // --- MODAL ACTIONS ---
    function openAddModal() {
        document.getElementById('form-main-student').reset();
        document.getElementById('edit-student-id').value = ''; 
        document.getElementById('modal-title').innerText = 'Add Student';
        toggleModal('add-modal', true);
    }

    function closeAddModal() { toggleModal('add-modal', false); }
    
    function toggleModal(id, show) {
        const el = document.getElementById(id);
        if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
        else { el.classList.add('hidden'); el.classList.remove('flex'); }
    }

    // --- FORM SUBMISSION WITH FILE UPLOAD ---
    async function handleFormSubmit(formId, isQuick=false) {
        const form = document.getElementById(formId);
        const formData = new FormData(form);
        const csrf = document.querySelector('meta[name="csrf-token"]').content;
        
        let url = '/api/students';
        let method = 'POST';

        if (!isQuick) {
            const id = document.getElementById('edit-student-id').value;
            if (id) {
                url = `/api/students/${id}`;
                method = 'PUT';
            }
        }

        try {
            // Use fetch directly for file uploads
            const res = await fetch(url, {
                method: method,
                body: formData,
                headers: { 'X-CSRFToken': csrf }
            });
            
            if(res.ok) {
                showToast(method === 'POST' ? 'Student added!' : 'Student updated!');
                if(!isQuick) closeAddModal();
                else form.reset();
                loadStudents();
            } else {
                showToast('Operation failed', 'error');
            }
        } catch (e) { 
            console.error(e);
            showToast('Error occurred', 'error');
        }
    }

    // Edit Student with Photo Support
    function editStudent(id) {
        const s = allStudents.find(x => x.id == id);
        if(!s) return;
        
        document.getElementById('edit-student-id').value = s.id;
        document.getElementById('modal-name').value = s.name;
        document.getElementById('modal-email').value = s.email || '';
        document.getElementById('modal-phone').value = s.phone || '';
        document.getElementById('modal-gender').value = s.gender || '';
        document.getElementById('modal-dob').value = s.date_of_birth || '';
        document.getElementById('modal-gname').value = s.guardian_name || '';
        document.getElementById('modal-gphone').value = s.guardian_phone || '';
        
        // Handle Hall
        const hallSelect = document.getElementById('modal-hall');
        hallSelect.value = s.hall || '';
        
        // Handle Program & Class (Cascading Fix)
        const progSelect = document.getElementById('modal-program');
        progSelect.value = s.program || '';
        
        // Force populate classes immediately
        updateClassOptions('modal');
        
        // Set class value after options exist
        setTimeout(() => {
            const classSelect = document.getElementById('modal-class');
            classSelect.value = s.class_room || '';
        }, 100);
        
        document.getElementById('modal-title').innerText = 'Edit Student';
        toggleModal('add-modal', true);
    }

    // --- BULK ACTION MODAL HANDLERS ---
    function openMoveHallModal() { toggleModal('move-hall-modal', true); }
    function closeMoveHallModal() { toggleModal('move-hall-modal', false); }
    function openUpdateProgramModal() { toggleModal('update-program-modal', true); }
    function closeUpdateProgramModal() { toggleModal('update-program-modal', false); }
    function openBulkEmailModal() { toggleModal('bulk-email-modal', true); }
    function closeBulkEmailModal() { toggleModal('bulk-email-modal', false); }
    function closeQuickViewModal() { toggleModal('quick-view-modal', false); }
    
    function openDeleteAllModal() { toggleModal('delete-all-modal', true); }
    function closeDeleteAllModal() { toggleModal('delete-all-modal', false); }

    function openDeleteModal(id, name) {
        deleteStudentId = id;
        document.getElementById('delete-student-name').innerText = name;
        toggleModal('delete-modal', true);
    }
    function closeDeleteModal() { toggleModal('delete-modal', false); }

    // --- BULK ACTIONS ---
    async function executeBulkAction() {
        const action = document.getElementById('bulk-action').value;
        if (selectedStudents.size === 0) return showToast('Select at least one student', 'warning');
        
        if (action === 'move-form') toggleModal('move-form-modal', true);
        else if (action === 'move-hall') openMoveHallModal();
        else if (action === 'update-program') openUpdateProgramModal();
        else if (action === 'email') openBulkEmailModal();
        else if (action === 'delete') {
            if(confirm(`Delete ${selectedStudents.size} student(s)?`)) {
                try {
                    const ids = Array.from(selectedStudents);
                    await apiRequest('/api/students/bulk-delete', {
                        method: 'POST',
                        body: JSON.stringify({ ids })
                    });
                    showToast(`Deleted ${ids.length} student(s)`);
                    clearSelections();
                    loadStudents();
                } catch(e) {
                    showToast('Deletion failed', 'error');
                }
            }
        }
        
        document.getElementById('bulk-action').value = "";
    }

    // --- MOVE FORM LOGIC ---
    async function confirmMoveForm() {
        const target = document.getElementById('target-form-select').value;
        const ids = Array.from(selectedStudents);
        try {
            await apiRequest('/api/students/move-form', {
                method: 'POST', 
                body: JSON.stringify({ ids, target_form: target })
            });
            showToast('Form Levels Updated');
            toggleModal('move-form-modal', false);
            clearSelections();
            loadStudents();
        } catch(e) {
            showToast('Update failed', 'error');
        }
    }

    async function confirmDelete() {
        try {
            await apiRequest(`/api/students/${deleteStudentId}`, { method: 'DELETE' });
            showToast('Deleted successfully');
            closeDeleteModal();
            loadStudents();
        } catch(e) {
            showToast('Deletion failed', 'error');
        }
    }
    
    async function confirmDeleteAll() {
        const password = document.getElementById('admin-password').value;
        try {
            const res = await apiRequest('/api/students/delete-all', { method: 'POST', body: JSON.stringify({password}) });
            showToast(res.message);
            closeDeleteAllModal();
            loadStudents();
        } catch(e) {
            showToast('Operation failed', 'error');
        }
    }

    function setupEventListeners() {
        // Form submissions
        document.getElementById('form-main-student').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleFormSubmit('form-main-student'); 
        });
        
        document.getElementById('form-quick-add').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleFormSubmit('form-quick-add', true); 
        });

        // Bulk email form
        document.getElementById('bulk-email-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subject = document.getElementById('email-subject').value;
            const message = document.getElementById('email-message').value;
            const ids = Array.from(selectedStudents);
            
            try {
                await apiRequest('/api/students/send-bulk-email', {
                    method: 'POST',
                    body: JSON.stringify({ ids, subject, message })
                });
                showToast('Email sent to selected students');
                closeBulkEmailModal();
            } catch(e) {
                showToast('Email sending failed', 'error');
            }
        });

        // Pagination
        document.getElementById('items-per-page')?.addEventListener('change', (e) => {
            itemsPerPage = e.target.value === 'all' ? 10000 : parseInt(e.target.value);
            currentPage = 1;
            renderStudents();
        });
        document.getElementById('next-page').addEventListener('click', () => { 
            currentPage++; 
            renderStudents(); 
        });
        document.getElementById('prev-page').addEventListener('click', () => { 
            currentPage--; 
            renderStudents(); 
        });
    }

    // Quick View Function
    async function quickView(id) {
        try {
            const data = await apiRequest(`/api/students/${id}`);
            const s = data.student;
            const content = document.getElementById('quick-view-content');
            
            const age = s.date_of_birth ? calculateAge(s.date_of_birth) : null;
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    ${s.photo_url 
                        ? `<img src="${s.photo_url}" class="w-32 h-32 rounded-full object-cover border-4 border-gold-500/30 mx-auto mb-4 shadow-xl">` 
                        : `<div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-600 to-indigo-900 flex items-center justify-center text-4xl font-bold text-white border-4 border-gold-500/30 mx-auto mb-4 shadow-xl">${s.name.charAt(0)}</div>`
                    }
                    <h3 class="text-2xl font-bold text-theme-main">${s.name}</h3>
                    <p class="text-theme-muted">${s.program || 'No Program'}  ${age ? `${age} years` : ''}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-white/5 p-3 rounded-lg">
                        <div class="text-theme-muted text-xs uppercase mb-1">Class</div>
                        <div class="font-bold">${s.class_room || '-'}</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg">
                        <div class="text-theme-muted text-xs uppercase mb-1">Hall</div>
                        <div class="font-bold">${s.hall || '-'}</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg">
                        <div class="text-theme-muted text-xs uppercase mb-1">Email</div>
                        <div class="font-bold truncate">${s.email || '-'}</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg">
                        <div class="text-theme-muted text-xs uppercase mb-1">Phone</div>
                        <div class="font-bold">${s.phone || '-'}</div>
                    </div>
                </div>
                ${s.guardian_name || s.guardian_phone ? `
                <div class="mt-6 pt-6 border-t border-white/10">
                    <h4 class="text-gold font-bold mb-3">Guardian Info</h4>
                    <div class="text-sm">
                        ${s.guardian_name ? `<div><span class="text-theme-muted">Name:</span> ${s.guardian_name}</div>` : ''}
                        ${s.guardian_phone ? `<div class="mt-1"><span class="text-theme-muted">Phone:</span> ${s.guardian_phone}</div>` : ''}
                    </div>
                </div>` : ''}
            `;
            
            toggleModal('quick-view-modal', true);
        } catch(e) {
            showToast('Failed to load student details', 'error');
        }
    }

    // Helper function for age calculation
    function calculateAge(dob) {
        if (!dob) return null;
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    // Export functions
    function exportToCSV() {
        showToast('CSV export started', 'info');
        // Implement CSV export logic here
    }

    function exportToExcel() {
        showToast('Excel export started', 'info');
        // Implement Excel export logic here
    }
</script>
{% endblock %}