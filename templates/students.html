{% extends "base.html" %}

{% block title %}Students - SchoolSync Pro{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-theme-main">Students</h1>
            <p class="text-theme-muted">Browse and manage student records</p>
        </div>
        <div class="flex space-x-3">
            <!-- Delete All Button -->
            <button onclick="openDeleteAllModal()" class="px-4 py-2 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 transition flex items-center group">
                <i class="material-icons-round mr-2">delete_sweep</i>
                <span>Delete All</span>
            </button>

            <a href="/import" class="px-6 py-2 rounded-xl border border-white/10 hover:bg-white/10 text-theme-main transition flex items-center group">
                <i class="material-icons-round mr-2 text-gold group-hover:scale-110 transition">cloud_upload</i>
                <span>Import</span>
            </a>
            <button onclick="openAddModal()" class="btn-gold px-6 py-2 rounded-xl text-black flex items-center font-bold shadow-lg hover:shadow-yellow-500/20 transition">
                <i class="material-icons-round mr-2">person_add</i>
                <span>Add Student</span>
            </button>
        </div>
    </div>

    <!-- Top Stats Bar (Fixed Missing ID Errors) -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-500/20"></div>
            <p class="text-theme-muted text-sm">Total Students</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="total-count">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-blue-500/20">groups</i>
        </div>
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-green-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-green-500/20"></div>
            <p class="text-theme-muted text-sm">Avg Age</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="avg-age">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-green-500/20">cake</i>
        </div>
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-purple-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-purple-500/20"></div>
            <p class="text-theme-muted text-sm">Top Program</p>
            <p class="text-xl font-bold text-theme-main mt-1 truncate" id="top-program">-</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-purple-500/20">school</i>
        </div>
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-yellow-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-yellow-500/20"></div>
            <p class="text-theme-muted text-sm">New This Month</p>
            <p class="text-2xl font-bold text-theme-main mt-1" id="new-this-month">0</p>
            <i class="material-icons-round absolute bottom-4 right-4 text-3xl text-yellow-500/20">person_add</i>
        </div>
    </div>

    <!-- Quick Add Form -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleQuickAdd()">
            <h3 class="font-bold text-theme-main flex items-center">
                <i class="material-icons-round text-gold mr-2">flash_on</i>
                Quick Add Student
            </h3>
            <i id="quick-add-arrow" class="material-icons-round text-theme-muted">keyboard_arrow_down</i>
        </div>
        
        <div id="quick-add-form" class="hidden mt-6 pt-6 border-t border-white/10">
            <form id="quick-add" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" name="name" placeholder="Full Name *" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    
                    <select name="program" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Program...</option>
                        <option value="General Science">General Science</option>
                        <option value="Business">Business</option>
                        <option value="General Arts">General Arts</option>
                        <option value="Visual Arts">Visual Arts</option>
                        <option value="Agriculture">Agriculture</option>
                        <option value="Home Economics">Home Economics</option>
                    </select>

                    <select name="class_room" required class="w-full px-4 py-3 bg-black/20 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Class...</option>
                        {% for i in range(1, 4) %}
                            {% for stream in ['Science', 'Business', 'GeneralArts', 'VisualArts', 'Agriculture'] %}
                                {% set count = 13 if stream == 'Science' else (9 if stream in ['Business', 'GeneralArts'] else (3 if stream == 'VisualArts' else 2)) %}
                                {% for num in range(1, count + 1) %}
                                    <option value="{{ i }}-{{ stream }}-{{ num }}">{{ i }}-{{ stream }}-{{ num }}</option>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </select>

                    <button type="submit" class="btn-gold px-6 py-3 rounded-xl text-black flex items-center justify-center font-bold">
                        <i class="material-icons-round mr-2">add</i> Add
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Actions Toolbar -->
    <div class="glass-card p-4 flex flex-col lg:flex-row items-center justify-between gap-4">
        <!-- View Toggles -->
        <div class="flex bg-black/20 rounded-lg p-1">
            <button id="view-grid" onclick="setViewMode('grid')" class="px-4 py-2 rounded-md text-gold bg-white/10 transition flex items-center">
                <i class="material-icons-round mr-2">grid_view</i> Grid
            </button>
            <button id="view-table" onclick="setViewMode('table')" class="px-4 py-2 rounded-md text-theme-muted hover:text-white transition flex items-center">
                <i class="material-icons-round mr-2">table_rows</i> Table
            </button>
            <button id="view-list" onclick="setViewMode('list')" class="px-4 py-2 rounded-md text-theme-muted hover:text-white transition flex items-center">
                <i class="material-icons-round mr-2">view_list</i> List
            </button>
        </div>

        <!-- Items Per Page -->
        <div class="flex items-center space-x-3">
            <span class="text-sm text-theme-muted">Show:</span>
            <select id="items-per-page" class="px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main focus:border-gold-500">
                <option value="12">12</option>
                <option value="24">24</option>
                <option value="48">48</option>
                <option value="1000">All</option>
            </select>
        </div>
        
        <!-- Export Actions -->
        <div class="flex space-x-2">
            <button onclick="exportToCSV()" class="p-2 rounded-lg hover:bg-white/10 text-green-400 transition" title="Export CSV"><i class="material-icons-round">description</i></button>
            <button onclick="exportToExcel()" class="p-2 rounded-lg hover:bg-white/10 text-blue-400 transition" title="Export Excel"><i class="material-icons-round">table_view</i></button>
        </div>
    </div>

    <!-- Bulk Actions Panel -->
    <div id="bulk-actions-panel" class="hidden glass-card p-4 border-l-4 border-gold-500 animate-fade-in flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center bg-gold-500/20 px-3 py-1 rounded-lg text-gold border border-gold-500/30">
                <i class="material-icons-round text-sm mr-2">check_box</i>
                <span id="selected-count" class="font-bold">0</span> &nbsp;Selected
            </div>
            
            <div class="flex items-center gap-2">
                <select id="bulk-action" class="px-4 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm focus:border-gold-500">
                    <option value="">Select Action...</option>
                    <option value="email">Send Email</option>
                    <option value="move-hall">Move Hall</option>
                    <option value="update-program">Update Program</option>
                    <option value="export">Export Selected</option>
                </select>
                <button onclick="executeBulkAction()" class="btn-gold px-4 py-2 rounded-lg text-sm text-black font-bold">Apply</button>
            </div>
        </div>
        <button onclick="clearSelections()" class="text-theme-muted hover:text-white text-sm flex items-center"><i class="material-icons-round text-sm mr-1">close</i> Clear</button>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar Filters -->
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-card p-6 sticky top-24">
                <h3 class="font-bold text-theme-main mb-4 flex items-center"><i class="material-icons-round text-gold mr-2">filter_list</i> Filters</h3>
                <div class="mb-6 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                    <p class="text-sm text-blue-300 font-medium text-center">Showing <span id="filtered-count" class="text-white font-bold">0</span> students</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Search</label>
                        <input type="text" id="name-search" placeholder="Name, ID..." class="w-full pl-3 pr-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm focus:border-gold-500 transition">
                    </div>
                    <div>
                        <label class="text-xs text-theme-muted uppercase tracking-wider mb-1 block">Hall</label>
                        <select id="quick-hall-filter" onchange="filterByHall(this.value)" class="w-full px-3 py-2 bg-black/20 border border-white/10 rounded-lg text-theme-main text-sm transition">
                            <option value="">All Halls</option>
                            <option value="Alema Hall">Alema Hall</option>
                            <option value="Ellen Hall">Ellen Hall</option>
                            <option value="Halm Addo Hall">Halm Addo Hall</option>
                            <option value="Nana Wereko Ampem II Hall">Nana Wereko Ampem II Hall</option>
                            <option value="Wilson Q .Tei Hall">Wilson Q .Tei Hall</option>
                            <option value="Awuletey Hall">Awuletey Hall</option>
                            <option value="Peter Ala Adjetey Hall">Peter Ala Adjetey Hall</option>
                            <option value="Nana Akuako Sarpong Hall">Nana Akuako Sarpong Hall</option>
                            <option value="Nana Awuah Darko Ampem Hall">Nana Awuah Darko Ampem Hall</option>
                        </select>
                    </div>
                    <button onclick="resetAllFilters()" class="w-full py-2 border border-white/10 rounded-lg text-theme-muted hover:text-white hover:bg-white/5 transition text-sm flex items-center justify-center">
                        <i class="material-icons-round text-sm mr-2">refresh</i> Reset Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Area -->
        <div class="lg:col-span-3">
            <div id="students-grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="students-table-view" class="hidden glass-card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-black/20 text-theme-muted text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox" id="select-all-table" class="rounded bg-black/20 border-white/20 text-gold focus:ring-0"></th>
                                <th class="px-6 py-3">Student</th>
                                <th class="px-6 py-3">Program</th>
                                <th class="px-6 py-3">Class</th>
                                <th class="px-6 py-3">Hall</th>
                                <th class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="text-sm text-theme-main divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
            <div id="students-list-view" class="hidden space-y-3"></div>

            <div id="loading-state" class="text-center py-20">
                <div class="w-12 h-12 border-4 border-gold-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-theme-muted">Loading students...</p>
            </div>
            <div id="empty-state" class="hidden text-center py-20">
                <i class="material-icons-round text-4xl text-theme-muted mb-3">search_off</i>
                <h3 class="text-xl font-bold text-theme-main">No students found</h3>
            </div>

            <div id="pagination" class="hidden flex items-center justify-between pt-6 mt-6 border-t border-white/10">
                <span class="text-sm text-theme-muted">Page <span id="pagination-start" class="text-white font-bold">1</span></span>
                <div class="flex space-x-2">
                    <button id="prev-page" class="p-2 rounded-lg border border-white/10 hover:bg-white/10 text-theme-muted disabled:opacity-30"><i class="material-icons-round">chevron_left</i></button>
                    <button id="next-page" class="p-2 rounded-lg border border-white/10 hover:bg-white/10 text-theme-muted disabled:opacity-30"><i class="material-icons-round">chevron_right</i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Delete All Students Modal -->
<div id="delete-all-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-red-500/50 shadow-[0_0_50px_rgba(239,68,68,0.2)]">
        <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 border border-red-500/30">
            <i class="material-icons-round text-4xl">warning</i>
        </div>
        <h3 class="text-2xl font-bold text-theme-main mb-2">Delete Everything?</h3>
        <p class="text-theme-muted mb-6">This will wipe all students and records database. This action is irreversible.</p>
        
        <input type="password" id="admin-password" placeholder="Enter Admin Password" class="w-full px-4 py-3 bg-black/40 border border-red-500/30 rounded-xl text-white mb-6 focus:border-red-500 focus:ring-1 focus:ring-red-500">
        
        <div class="flex gap-3">
            <button onclick="confirmDeleteAll()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg">Wipe Data</button>
            <button onclick="closeDeleteAllModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl">Cancel</button>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="add-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 animate-fade-in shadow-2xl border border-white/10">
        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h3 class="text-2xl font-bold text-theme-main" id="modal-title">Student Details</h3>
            <button onclick="closeAddModal()" class="text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        </div>
        
        <form id="add-student-form" class="space-y-6">
            <input type="hidden" id="edit-student-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Full Name</label>
                    <input type="text" name="name" id="modal-name" required class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Gender</label>
                    <select name="gender" id="modal-gender" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Program</label>
                    <select name="program" id="modal-program" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Program...</option>
                        <option value="General Science">General Science</option>
                        <option value="Business">Business</option>
                        <option value="General Arts">General Arts</option>
                        <option value="Visual Arts">Visual Arts</option>
                        <option value="Agriculture">Agriculture</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Hall</label>
                    <select name="hall" id="modal-hall" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Hall...</option>
                        <option value="Alema Hall">Alema Hall</option>
                        <option value="Ellen Hall">Ellen Hall</option>
                        <option value="Halm Addo Hall">Halm Addo Hall</option>
                        <option value="Nana Wereko Ampem II Hall">Nana Wereko Ampem II Hall</option>
                        <option value="Wilson Q .Tei Hall">Wilson Q .Tei Hall</option>
                        <option value="Awuletey Hall">Awuletey Hall</option>
                        <option value="Peter Ala Adjetey Hall">Peter Ala Adjetey Hall</option>
                        <option value="Nana Akuako Sarpong Hall">Nana Akuako Sarpong Hall</option>
                        <option value="Nana Awuah Darko Ampem Hall">Nana Awuah Darko Ampem Hall</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Class</label>
                    <select name="class_room" id="modal-class" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                        <option value="">Select Class...</option>
                        {% for i in range(1, 4) %}
                            {% for stream in ['Science', 'Business', 'GeneralArts', 'VisualArts', 'Agriculture'] %}
                                {% set count = 13 if stream == 'Science' else (9 if stream in ['Business', 'GeneralArts'] else (3 if stream == 'VisualArts' else 2)) %}
                                {% for num in range(1, count + 1) %}
                                    <option value="{{ i }}-{{ stream }}-{{ num }}">{{ i }}-{{ stream }}-{{ num }}</option>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Date of Birth</label>
                    <input type="date" name="date_of_birth" id="modal-dob" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Email</label>
                    <input type="email" name="email" id="modal-email" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-theme-muted uppercase font-bold">Phone</label>
                    <input type="tel" name="phone" id="modal-phone" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
            </div>
            
            <div class="border-t border-white/10 pt-4">
                <p class="text-gold text-sm font-bold mb-3 uppercase tracking-wider">Guardian Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="guardian_name" id="modal-gname" placeholder="Guardian Name" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                    <input type="tel" name="guardian_phone" id="modal-gphone" placeholder="Guardian Phone" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                </div>
            </div>
            
            <div class="flex space-x-4 pt-2">
                <button type="submit" class="flex-1 btn-gold py-3 rounded-xl text-black font-bold shadow-lg hover:scale-[1.02] transition">Save Student</button>
                <button type="button" onclick="closeAddModal()" class="px-8 border border-white/10 rounded-xl text-theme-muted hover:bg-white/10 hover:text-white transition">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Move Hall Modal -->
<div id="move-hall-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4">Move Students</h3>
        <div class="space-y-4">
            <select id="new-hall" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                <option value="">Select New Hall...</option>
                <option value="Alema Hall">Alema Hall</option>
                <option value="Ellen Hall">Ellen Hall</option>
                <option value="Halm Addo Hall">Halm Addo Hall</option>
                <option value="Nana Wereko Ampem II Hall">Nana Wereko Ampem II Hall</option>
                <option value="Wilson Q .Tei Hall">Wilson Q .Tei Hall</option>
                <option value="Awuletey Hall">Awuletey Hall</option>
                <option value="Peter Ala Adjetey Hall">Peter Ala Adjetey Hall</option>
                <option value="Nana Akuako Sarpong Hall">Nana Akuako Sarpong Hall</option>
                <option value="Nana Awuah Darko Ampem Hall">Nana Awuah Darko Ampem Hall</option>
            </select>
            <div class="flex gap-3">
                <button onclick="confirmMoveHall()" class="flex-1 btn-gold py-2 rounded-lg text-black font-bold">Move</button>
                <button onclick="closeMoveHallModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Program Modal -->
<div id="update-program-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4">Update Program</h3>
        <div class="space-y-4">
            <select id="new-program" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-gold-500">
                <option value="">Select New Program...</option>
                <option value="General Science">General Science</option>
                <option value="Business">Business</option>
                <option value="General Arts">General Arts</option>
                <option value="Visual Arts">Visual Arts</option>
                <option value="Agriculture">Agriculture</option>
            </select>
            <div class="flex gap-3">
                <button onclick="confirmUpdateProgram()" class="flex-1 btn-gold py-2 rounded-lg text-black font-bold">Update</button>
                <button onclick="closeUpdateProgramModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Email Modal -->
<div id="bulk-email-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-lg p-8 animate-fade-in">
        <h3 class="text-xl font-bold text-theme-main mb-4 flex items-center"><i class="material-icons-round text-blue-400 mr-2">email</i> Send Email</h3>
        <form id="bulk-email-form" class="space-y-4">
            <input type="text" id="email-subject" placeholder="Subject" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-blue-500">
            <textarea id="email-message" rows="5" placeholder="Message..." class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-theme-main focus:border-blue-500"></textarea>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeBulkEmailModal()" class="px-4 py-2 text-theme-muted hover:text-white transition">Cancel</button>
                <button type="submit" class="btn-gold px-6 py-2 rounded-lg text-black font-bold">Send</button>
            </div>
        </form>
    </div>
</div>

<!-- Quick View Modal -->
<div id="quick-view-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-md p-8 animate-fade-in relative">
        <button onclick="closeQuickViewModal()" class="absolute top-4 right-4 text-theme-muted hover:text-white transition"><i class="material-icons-round text-2xl">close</i></button>
        <div id="quick-view-content"></div>
    </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-md">
    <div class="glass-card w-full max-w-sm p-8 text-center animate-fade-in border border-red-500/30">
        <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 shadow-[0_0_20px_rgba(239,68,68,0.2)]">
            <i class="material-icons-round text-3xl">delete_forever</i>
        </div>
        <h3 class="text-xl font-bold text-theme-main mb-2">Delete Student?</h3>
        <p class="text-theme-muted mb-6">Are you sure you want to delete <span id="delete-student-name" class="text-white font-bold"></span>?</p>
        <div class="flex gap-3">
            <button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-bold shadow-lg">Delete</button>
            <button onclick="closeDeleteModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // --- UTILS ---
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // --- STATE MANAGEMENT ---
    let allStudents = [];
    let filteredStudents = [];
    let selectedStudents = new Set();
    let currentPage = 1;
    let itemsPerPage = 12;
    let currentViewMode = 'grid';
    let deleteStudentId = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadStudents();
        setupEventListeners();
    });

    // --- DATA LOADING ---
    async function loadStudents() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        
        try {
            const timestamp = new Date().getTime();
            const data = await apiRequest(`/api/students?per_page=1000&_t=${timestamp}`);
            allStudents = data.students || [];
            filteredStudents = [...allStudents];
            
            console.log(`Loaded ${allStudents.length} students`);
            updateStats();
            renderStudents();
        } catch (error) {
            console.error('Data Load Error:', error);
            showToast('Failed to load data', 'error');
        } finally {
            document.getElementById('loading-state').classList.add('hidden');
        }
    }

    // --- RENDERING ---
    function renderStudents() {
        const grid = document.getElementById('students-grid-view');
        const table = document.getElementById('students-table-view');
        const list = document.getElementById('students-list-view');
        const pagination = document.getElementById('pagination');

        grid.classList.add('hidden');
        table.classList.add('hidden');
        list.classList.add('hidden');

        if(filteredStudents.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
            pagination.classList.add('hidden');
            return;
        }
        document.getElementById('empty-state').classList.add('hidden');

        const start = (currentPage - 1) * itemsPerPage;
        const end = itemsPerPage === 10000 ? filteredStudents.length : Math.min(start + itemsPerPage, filteredStudents.length);
        const pageData = filteredStudents.slice(start, end);

        document.getElementById('pagination-start').textContent = start + 1;
        document.getElementById('pagination-end').textContent = end;
        document.getElementById('pagination-total').textContent = filteredStudents.length;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = end >= filteredStudents.length;
        pagination.classList.remove('hidden');

        const safe = (val) => (val === null || val === undefined) ? '' : val;
        const getInitial = (name) => (name ? name.charAt(0) : '?');

        if (currentViewMode === 'grid') {
            grid.classList.remove('hidden');
            grid.innerHTML = pageData.map(s => `
                <div class="glass-card p-6 relative group hover:border-gold-500/50 transition duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-900 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                            ${getInitial(s.name)}
                        </div>
                        <input type="checkbox" class="student-checkbox w-5 h-5 rounded border-white/20 bg-black/20 text-gold focus:ring-0 cursor-pointer" 
                               value="${s.id}" ${selectedStudents.has(s.id) ? 'checked' : ''} 
                               onchange="toggleSelection(${s.id}, this.checked)">
                    </div>
                    <h3 class="text-lg font-bold text-theme-main truncate" title="${safe(s.name)}">${safe(s.name)}</h3>
                    <p class="text-sm text-theme-muted mb-4 truncate">${safe(s.program) || 'No Program'}</p>
                    
                    <div class="space-y-2 text-xs text-theme-muted border-t border-white/10 pt-3">
                        <div class="flex items-center"><i class="material-icons-round text-sm mr-2 text-blue-400">school</i> ${safe(s.current_form)}</div>
                        <div class="flex items-center"><i class="material-icons-round text-sm mr-2 text-green-400">location_on</i> ${safe(s.hall) || 'N/A'}</div>
                    </div>

                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-white/5 opacity-0 group-hover:opacity-100 transition duration-300">
                        <button onclick="quickView(${s.id})" class="text-blue-400 hover:text-white transition"><i class="material-icons-round">visibility</i></button>
                        <button onclick="editStudent(${s.id})" class="text-yellow-400 hover:text-white transition"><i class="material-icons-round">edit</i></button>
                        ${s.email ? `<a href="mailto:${s.email}" class="text-green-400 hover:text-white transition"><i class="material-icons-round">email</i></a>` : ''}
                        <button onclick="openDeleteModal(${s.id}, '${safe(s.name).replace(/'/g, "\\'")}')" class="text-red-400 hover:text-white transition"><i class="material-icons-round">delete</i></button>
                    </div>
                </div>
            `).join('');
        } 
        else if (currentViewMode === 'table') {
            table.classList.remove('hidden');
            document.getElementById('students-table-body').innerHTML = pageData.map(s => `
                <tr class="hover:bg-white/5 transition group">
                    <td class="px-6 py-4"><input type="checkbox" class="student-checkbox rounded bg-black/20 border-white/20 text-gold focus:ring-0 cursor-pointer" value="${s.id}" ${selectedStudents.has(s.id) ? 'checked' : ''} onchange="toggleSelection(${s.id}, this.checked)"></td>
                    <td class="px-6 py-4 font-medium text-theme-main">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-900 flex items-center justify-center text-xs text-white font-bold">${getInitial(s.name)}</div>
                            ${safe(s.name)}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-theme-muted">${safe(s.program) || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-blue-500/10 text-blue-300 text-xs border border-blue-500/20">${safe(s.class_room) || '-'}</span></td>
                    <td class="px-6 py-4 text-theme-muted">${safe(s.hall) || '-'}</td>
                    <td class="px-6 py-4 flex gap-2 opacity-50 group-hover:opacity-100 transition">
                        <button onclick="editStudent(${s.id})" class="text-gold hover:scale-110 transition"><i class="material-icons-round text-sm">edit</i></button>
                        <button onclick="openDeleteModal(${s.id}, '${safe(s.name)}')" class="text-red-400 hover:scale-110 transition"><i class="material-icons-round text-sm">delete</i></button>
                    </td>
                </tr>
            `).join('');
        }
        else if (currentViewMode === 'list') {
            list.classList.remove('hidden');
            list.innerHTML = pageData.map(s => `
                <div class="glass-card p-4 flex items-center justify-between hover:border-gold-500/30 transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-gray-800 flex items-center justify-center text-white font-bold border border-white/10">${getInitial(s.name)}</div>
                        <div>
                            <h4 class="font-bold text-theme-main">${safe(s.name)}</h4>
                            <p class="text-xs text-theme-muted">${safe(s.program)} â€¢ ${safe(s.class_room)}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="quickView(${s.id})" class="p-2 bg-white/5 rounded-lg hover:bg-white/10 text-blue-400"><i class="material-icons-round">visibility</i></button>
                        <button onclick="editStudent(${s.id})" class="p-2 bg-white/5 rounded-lg hover:bg-white/10 text-yellow-400"><i class="material-icons-round">edit</i></button>
                    </div>
                </div>
            `).join('');
        }
    }

    function updateStats() {
        if(document.getElementById('total-count')) document.getElementById('total-count').innerText = allStudents.length;
        
        const ages = allStudents.filter(s => s.age).map(s => s.age);
        const avg = ages.length ? Math.round(ages.reduce((a,b)=>a+b,0)/ages.length) : 0;
        if(document.getElementById('avg-age')) document.getElementById('avg-age').innerText = avg;

        const counts = {};
        allStudents.forEach(s => s.program && (counts[s.program] = (counts[s.program] || 0) + 1));
        const top = Object.entries(counts).sort((a,b) => b[1]-a[1])[0];
        if(document.getElementById('top-program')) document.getElementById('top-program').innerText = top ? top[0] : '-';

        const now = new Date();
        const count = allStudents.filter(s => {
            const d = new Date(s.created_at);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }).length;
        if(document.getElementById('new-this-month')) document.getElementById('new-this-month').innerText = count;
    }

    // --- INTERACTIONS ---
    function setViewMode(mode) {
        currentViewMode = mode;
        ['grid', 'table', 'list'].forEach(m => {
            const btn = document.getElementById(`view-${m}`);
            btn.className = m === mode ? 
                'px-4 py-2 rounded-md text-gold bg-white/10 transition flex items-center shadow-inner' : 
                'px-4 py-2 rounded-md text-theme-muted hover:text-white transition flex items-center';
        });
        renderStudents();
    }

    function toggleSelection(id, checked) {
        if(checked) selectedStudents.add(id);
        else selectedStudents.delete(id);
        document.getElementById('selected-count').textContent = selectedStudents.size;
        document.getElementById('bulk-actions-panel').classList.toggle('hidden', selectedStudents.size === 0);
    }

    document.getElementById('select-all-table')?.addEventListener('change', (e) => {
        const checked = e.target.checked;
        const visibleIds = filteredStudents.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage).map(s => s.id);
        visibleIds.forEach(id => toggleSelection(id, checked));
        renderStudents();
    });

    function clearSelections() {
        selectedStudents.clear();
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
        if(document.getElementById('select-all-table')) document.getElementById('select-all-table').checked = false;
        document.getElementById('bulk-actions-panel').classList.add('hidden');
    }

    function toggleQuickAdd() {
        const form = document.getElementById('quick-add-form');
        form.classList.toggle('hidden');
        document.getElementById('quick-add-arrow').textContent = form.classList.contains('hidden') ? 'keyboard_arrow_down' : 'keyboard_arrow_up';
    }

    // --- FILTERING ---
    function applyAdvancedFilters() {
        const term = document.getElementById('name-search').value.toLowerCase();
        const hall = document.getElementById('quick-hall-filter').value;
        
        filteredStudents = allStudents.filter(s => {
            if(term && !s.name.toLowerCase().includes(term) && !String(s.id).includes(term)) return false;
            if(hall && s.hall !== hall) return false;
            return true;
        });
        document.getElementById('filtered-count').innerText = filteredStudents.length;
        currentPage = 1;
        renderStudents();
    }

    document.getElementById('name-search').addEventListener('input', debounce(applyAdvancedFilters, 300));

    function filterByHall(val) { applyAdvancedFilters(); }

    function filterByGender(g) {
        document.getElementById('name-search').value = ''; 
        filteredStudents = allStudents.filter(s => s.gender === g);
        renderStudents();
    }

    function resetAllFilters() {
        filteredStudents = [...allStudents];
        document.getElementById('name-search').value = '';
        document.getElementById('quick-hall-filter').value = '';
        renderStudents();
    }

    // --- MODALS (Secure Delete) ---
    function openDeleteAllModal() {
        document.getElementById('admin-password').value = '';
        document.getElementById('delete-all-modal').classList.remove('hidden');
        document.getElementById('delete-all-modal').classList.add('flex');
    }

    function closeDeleteAllModal() {
        document.getElementById('delete-all-modal').classList.add('hidden');
        document.getElementById('delete-all-modal').classList.remove('flex');
    }

    async function confirmDeleteAll() {
        const password = document.getElementById('admin-password').value;
        if (!password) return showToast('Password required', 'error');

        try {
            const res = await apiRequest('/api/students/delete-all', {
                method: 'POST',
                body: JSON.stringify({ password })
            });
            showToast(res.message);
            closeDeleteAllModal();
            loadStudents();
        } catch (e) {
            // Error handled by apiRequest
        }
    }

    // --- ADD/EDIT ---
    function openAddModal() {
        document.getElementById('add-student-form').reset();
        document.getElementById('edit-student-id').value = ''; 
        document.getElementById('modal-title').innerText = 'Add Student';
        document.getElementById('add-modal').classList.remove('hidden');
        document.getElementById('add-modal').classList.add('flex');
    }

    function closeAddModal() {
        document.getElementById('add-modal').classList.add('hidden');
        document.getElementById('add-modal').classList.remove('flex');
    }

    function editStudent(id) {
        const s = allStudents.find(x => x.id == id);
        if(!s) return;
        
        document.getElementById('edit-student-id').value = s.id;
        document.getElementById('modal-name').value = s.name;
        document.getElementById('modal-program').value = s.program || '';
        document.getElementById('modal-hall').value = s.hall || '';
        document.getElementById('modal-class').value = s.class_room || '';
        document.getElementById('modal-email').value = s.email || '';
        document.getElementById('modal-phone').value = s.phone || '';
        document.getElementById('modal-gender').value = s.gender || '';
        document.getElementById('modal-dob').value = s.date_of_birth || '';
        document.getElementById('modal-gname').value = s.guardian_name || '';
        document.getElementById('modal-gphone').value = s.guardian_phone || '';
        
        document.getElementById('modal-title').innerText = 'Edit Student';
        document.getElementById('add-modal').classList.remove('hidden');
        document.getElementById('add-modal').classList.add('flex');
    }

    // --- QUICK VIEW ---
    async function quickView(id) {
        const s = allStudents.find(x => x.id == id);
        if(!s) return;
        
        const content = `
            <div class="text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold mx-auto mb-4 border-4 border-white/10">
                    ${s.name.charAt(0)}
                </div>
                <h3 class="text-2xl font-bold text-theme-main">${s.name}</h3>
                <p class="text-theme-muted">${s.program || 'N/A'}</p>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-4 text-sm">
                <div class="bg-black/20 p-3 rounded-lg"><span class="block text-xs text-theme-muted">Hall</span><span class="text-theme-main">${s.hall || '-'}</span></div>
                <div class="bg-black/20 p-3 rounded-lg"><span class="block text-xs text-theme-muted">Class</span><span class="text-theme-main">${s.class_room || '-'}</span></div>
                <div class="bg-black/20 p-3 rounded-lg"><span class="block text-xs text-theme-muted">Form</span><span class="text-theme-main">${s.current_form}</span></div>
                <div class="bg-black/20 p-3 rounded-lg"><span class="block text-xs text-theme-muted">Age</span><span class="text-theme-main">${s.age || '-'}</span></div>
            </div>
            ${s.email ? `<a href="mailto:${s.email}" class="block mt-4 text-center text-blue-400 hover:text-blue-300 bg-blue-500/10 py-2 rounded-lg">${s.email}</a>` : ''}
        `;
        document.getElementById('quick-view-content').innerHTML = content;
        document.getElementById('quick-view-modal').classList.remove('hidden');
        document.getElementById('quick-view-modal').classList.add('flex');
    }

    function closeQuickViewModal() {
        document.getElementById('quick-view-modal').classList.add('hidden');
        document.getElementById('quick-view-modal').classList.remove('flex');
    }

    // --- BULK ACTION MODAL HANDLERS ---
    function openMoveHallModal() {
        document.getElementById('move-hall-modal').classList.remove('hidden');
        document.getElementById('move-hall-modal').classList.add('flex');
    }
    function closeMoveHallModal() {
        document.getElementById('move-hall-modal').classList.add('hidden');
        document.getElementById('move-hall-modal').classList.remove('flex');
    }
    function openUpdateProgramModal() {
        document.getElementById('update-program-modal').classList.remove('hidden');
        document.getElementById('update-program-modal').classList.add('flex');
    }
    function closeUpdateProgramModal() {
        document.getElementById('update-program-modal').classList.add('hidden');
        document.getElementById('update-program-modal').classList.remove('flex');
    }
    function openBulkEmailModal() {
        document.getElementById('bulk-email-modal').classList.remove('hidden');
        document.getElementById('bulk-email-modal').classList.add('flex');
    }
    function closeBulkEmailModal() {
        document.getElementById('bulk-email-modal').classList.add('hidden');
        document.getElementById('bulk-email-modal').classList.remove('flex');
    }

    // --- FORM SUBMISSION HANDLERS ---
    document.getElementById('add-student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-student-id').value;
        const data = Object.fromEntries(new FormData(e.target));
        
        const url = id ? `/api/students/${id}` : '/api/students';
        const method = id ? 'PUT' : 'POST';

        try {
            await apiRequest(url, { method, body: JSON.stringify(data) });
            showToast(id ? 'Updated successfully' : 'Created successfully');
            closeAddModal();
            loadStudents(); 
        } catch(e) { console.error(e); }
    });

    document.getElementById('quick-add').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await apiRequest('/api/students', { method: 'POST', body: JSON.stringify(data) });
            showToast('Added successfully');
            document.getElementById('quick-add').reset();
            loadStudents();
        } catch(e) {}
    });

    function openDeleteModal(id, name) {
        deleteStudentId = id;
        document.getElementById('delete-student-name').innerText = name;
        document.getElementById('delete-modal').classList.remove('hidden');
        document.getElementById('delete-modal').classList.add('flex');
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
        document.getElementById('delete-modal').classList.remove('flex');
    }

    async function confirmDelete() {
        try {
            await apiRequest(`/api/students/${deleteStudentId}`, { method: 'DELETE' });
            showToast('Deleted successfully');
            closeDeleteModal();
            loadStudents();
        } catch(e) {}
    }

    async function executeBulkAction() {
        const action = document.getElementById('bulk-action').value;
        if (selectedStudents.size === 0) return showToast('Select at least one student', 'warning');
        
        if (action === 'move-hall') openMoveHallModal();
        else if (action === 'update-program') openUpdateProgramModal();
        else if (action === 'email') openBulkEmailModal();
        else if (action === 'export') exportSelectedStudents();
        else if (action === 'archive') showToast('Archive feature pending implementation', 'info');
        
        document.getElementById('bulk-action').value = "";
    }

    function setupEventListeners() {
        document.getElementById('items-per-page').addEventListener('change', (e) => {
            itemsPerPage = e.target.value === 'all' ? 10000 : parseInt(e.target.value);
            currentPage = 1;
            renderStudents();
        });
        document.getElementById('next-page').addEventListener('click', () => { currentPage++; renderStudents(); });
        document.getElementById('prev-page').addEventListener('click', () => { currentPage--; renderStudents(); });
    }
</script>
{% endblock %}